on:
  pull_request:
    types: [closed]
    branches:
    - dev
    
name: CI-delete

permissions: write-all

jobs:
  infrastructure:
    runs-on: ubuntu-latest
    steps:
    - name: checkout
      uses: actions/checkout@v3
    - name: configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1-node16
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    - name: env
      uses: rlespinasse/github-slug-action@v4
      with:
        slug-maxlength: 35
    - name: stage
      run: |
         echo "STAGE=${GITHUB_BASE_REF##*/}" >> $GITHUB_ENV
         echo "datetime=$(date '+%Y-%m-%d %H:%M %Z')" >> $GITHUB_ENV
    - name: terraform-setup
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.0
    - name: run
      env:
        ID: ${{ github.event.number }}
        NAME: www.usetempo.ai
        ZONE: usetempo.ai
      run: |
        cd ./infrastructure/
        terraform fmt -check -diff -recursive -no-color
        terraform init -backend=true -get=true -reconfigure -upgrade
        terraform workspace select -or-create $STAGE'-'$ID'-'${GITHUB_HEAD_REF_SLUG}
        terraform plan -no-color -refresh=true \
          -var 'name='$NAME'/'$STAGE'-'$ID'-'${GITHUB_HEAD_REF_SLUG} \
          -var 'website='$STAGE'-'$ID'-'${GITHUB_HEAD_REF_SLUG}'.'$ZONE \
          -var 'zone='$ZONE
        terraform destroy -no-color -auto-approve \
          -var 'name='$NAME'/'$STAGE'-'$ID'-'${GITHUB_HEAD_REF_SLUG} \
          -var 'website='$STAGE'-'$ID'-'${GITHUB_HEAD_REF_SLUG}'.'$ZONE \
          -var 'zone='$ZONE
    - name: deployment-deactivate
      if: always()
      uses: bobheadxi/deployments@v1
      env:
        ID: ${{ github.event.number }}
      with:
        step: deactivate-env
        token: ${{ github.token }}
        env: ${{ env.STAGE }}-${{ env.ID }}-${{ env.GITHUB_HEAD_REF_SLUG }}
    - name: deployment-deactivate-comment
      if: success()
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: pr-preview
        message: "\
          [PR-preview]

          :---:

          :robot: preview removed because PR was closed
          
          ${{ env.datetime }}
          "
